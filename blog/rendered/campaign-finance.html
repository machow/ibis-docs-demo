<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>. - Exploring Campaign Finance Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">.</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../concept/why_ibis.html" rel="" target="">
 <span class="menu-text">Why Ibis?</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorial/index.html" rel="" target="">
 <span class="menu-text">Ibis tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../how_to/configuration.html" rel="" target="">
 <span class="menu-text">Configure Ibis</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../reference/index.html" rel="" target="">
 <span class="menu-text">Reference</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../blog/rendered/ibis-version-6.0.0-release.html" rel="" target="" aria-current="page">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../release_notes.html" rel="" target="">
 <span class="menu-text">🚧 Release notes</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../blog/rendered/campaign-finance.html">Exploring Campaign Finance Data</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/rendered/ibis-version-6.0.0-release.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ibis v6.0.0</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/rendered/torch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ibis on 🔥: Supercharge Your Workflow with DuckDB and PyTorch</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/rendered/campaign-finance.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Exploring Campaign Finance Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/ibis-to-file.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ibis Sneak Peek: Writing to Files</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/ibis-examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ibis Sneak Peek: Examples</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/selectors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Maximizing Productivity with Selectors</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/ibis_substrait_to_duckdb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ibis + Substrait + DuckDB</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/ibis-version-4.0.0-release.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ibis v4.0.0</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/rendered/ci-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis of Ibis’s CI Performance</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/ffill-and-bfill-using-ibis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><code>ffill</code> and <code>bfill</code> using Ibis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/Ibis-version-3.1.0-release.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ibis v3.1.0</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog/Ibis-version-3.0.0-release.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ibis v3.0.0</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#downloading-the-data" id="toc-downloading-the-data" class="nav-link active" data-scroll-target="#downloading-the-data">Downloading The Data</a></li>
  <li><a href="#loading-the-data" id="toc-loading-the-data" class="nav-link" data-scroll-target="#loading-the-data">Loading the data</a>
  <ul class="collapse">
  <li><a href="#committees-data" id="toc-committees-data" class="nav-link" data-scroll-target="#committees-data">Committees Data</a></li>
  </ul></li>
  <li><a href="#cleaning" id="toc-cleaning" class="nav-link" data-scroll-target="#cleaning">Cleaning</a></li>
  <li><a href="#adding-features" id="toc-adding-features" class="nav-link" data-scroll-target="#adding-features">Adding Features</a></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a>
  <ul class="collapse">
  <li><a href="#by-donation-size" id="toc-by-donation-size" class="nav-link" data-scroll-target="#by-donation-size">By donation size</a></li>
  <li><a href="#back-to-analysis" id="toc-back-to-analysis" class="nav-link" data-scroll-target="#back-to-analysis">Back to analysis</a></li>
  <li><a href="#by-election-stage" id="toc-by-election-stage" class="nav-link" data-scroll-target="#by-election-stage">By election stage</a></li>
  <li><a href="#by-recipient" id="toc-by-recipient" class="nav-link" data-scroll-target="#by-recipient">By recipient</a></li>
  <li><a href="#by-location" id="toc-by-location" class="nav-link" data-scroll-target="#by-location">By Location</a></li>
  <li><a href="#by-month" id="toc-by-month" class="nav-link" data-scroll-target="#by-month">By month</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Exploring Campaign Finance Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Hi! My name is <a href="https://www.linkedin.com/in/nicholas-b-crews/">Nick Crews</a>, and I’m a data engineer that looks at public campaign finance data.</p>
<p>In this post, I’ll walk through how I use Ibis to explore public campaign contribution data from the Federal Election Commission (FEC). We’ll do some loading, cleaning, featurizing, and visualization. There will be filtering, sorting, grouping, and aggregation.</p>
<section id="downloading-the-data" class="level2">
<h2 class="anchored" data-anchor-id="downloading-the-data">Downloading The Data</h2>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> zipfile <span class="im">import</span> ZipFile</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and unzip the 2018 individual contributions data</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://cg-519a459a-0ea3-42c2-b7bc-fa1143481f74.s3-us-gov-west-1.amazonaws.com/bulk-downloads/2018/indiv18.zip"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>zip_path <span class="op">=</span> Path(<span class="st">"indiv18.zip"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>csv_path <span class="op">=</span> Path(<span class="st">"indiv18.csv"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> zip_path.exists():</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    urlretrieve(url, zip_path)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> csv_path.exists():</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ZipFile(zip_path) <span class="im">as</span> zip_file, csv_path.<span class="bu">open</span>(<span class="st">"w"</span>) <span class="im">as</span> csv_file:</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> line <span class="kw">in</span> zip_file.<span class="bu">open</span>(<span class="st">"itcont.txt"</span>):</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>            csv_file.write(line.decode())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-the-data" class="level2">
<h2 class="anchored" data-anchor-id="loading-the-data">Loading the data</h2>
<p>Now that we have our raw data in a .csv format, let’s load it into Ibis, using the duckdb backend.</p>
<p>Note that a 4.3 GB .csv would be near the limit of what pandas could handle on my laptop with 16GB of RAM. In pandas, typically every time you perform a transformation on the data, a copy of the data is made. I could only do a few transformations before I ran out of memory.</p>
<p>With Ibis, this problem is solved in two different ways.</p>
<p>First, because they are designed to work with very large datasets, many (all?) SQL backends support out of core operations. The data lives on disk, and are only loaded in a streaming fashion when needed, and then written back to disk as the operation is performed.</p>
<p>Second, unless you explicitly ask for it, Ibis makes use of lazy evaluation. This means that when you ask for a result, the result is not persisted in memory. Only the original source data is persisted. Everything else is derived from this on the fly.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ibis</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibis <span class="im">import</span> _</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ibis.options.interactive <span class="op">=</span> <span class="va">True</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The raw .csv file doesn't have column names, so we will add them in the next step.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>raw <span class="op">=</span> ibis.read_csv(csv_path)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━┓
┃<span style="font-weight: bold"> column00  </span>┃<span style="font-weight: bold"> column01 </span>┃<span style="font-weight: bold"> column02 </span>┃<span style="font-weight: bold"> column03 </span>┃<span style="font-weight: bold"> column04           </span>┃<span style="font-weight: bold"> column05 </span>┃<span style="font-weight: bold"> column06 </span>┃<span style="font-weight: bold"> column07          </span>┃<span style="font-weight: bold"> column08     </span>┃<span style="font-weight: bold"> column09 </span>┃<span style="font-weight: bold"> column10  </span>┃<span style="font-weight: bold"> column11          </span>┃<span style="font-weight: bold"> column12                </span>┃<span style="font-weight: bold"> column13 </span>┃<span style="font-weight: bold"> column14 </span>┃<span style="font-weight: bold"> column15  </span>┃<span style="font-weight: bold"> column16        </span>┃<span style="font-weight: bold"> column17 </span>┃<span style="font-weight: bold"> column18 </span>┃<span style="font-weight: bold"> column19                                                        </span>┃<span style="font-weight: bold"> … </span>┃
┡━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>   │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>   │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>   │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>              │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>   │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>   │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>            │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>   │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>            │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>                  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>   │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>          │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>   │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>                                                          │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
├───────────┼──────────┼──────────┼──────────┼────────────────────┼──────────┼──────────┼───────────────────┼──────────────┼──────────┼───────────┼───────────────────┼─────────────────────────┼──────────┼──────────┼───────────┼─────────────────┼──────────┼──────────┼─────────────────────────────────────────────────────────────────┼───┤
│ C00401224 │ A        │ M6       │ P        │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">201804059101866001</span> │ 24T      │ IND      │ STOUFFER, LEIGH   │ AMSTELVEEN   │ ZZ       │ 1187RC    │ MYSELF            │ SELF EMPLOYED           │ 05172017 │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │ C00458000 │ SA11AI_81445687 │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1217152</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>        │ EARMARKED FOR PROGRESSIVE CHANGE CAMPAIGN COMMITTEE (C00458000) │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
│ C00401224 │ A        │ M6       │ P        │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">201804059101867748</span> │ 24T      │ IND      │ STRAWS, JOYCE     │ OCOEE        │ FL       │ 34761     │ SILVERSEA CRUISES │ RESERVATIONS SUPERVISOR │ 05182017 │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │ C00000935 │ SA11AI_81592336 │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1217152</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>        │ EARMARKED FOR DCCC (C00000935)                                  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
│ C00401224 │ A        │ M6       │ P        │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">201804059101867748</span> │ 24T      │ IND      │ STRAWS, JOYCE     │ OCOEE        │ FL       │ 34761     │ SILVERSEA CRUISES │ RESERVATIONS SUPERVISOR │ 05192017 │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │ C00000935 │ SA11AI_81627562 │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1217152</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>        │ EARMARKED FOR DCCC (C00000935)                                  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
│ C00401224 │ A        │ M6       │ P        │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">201804059101865942</span> │ 24T      │ IND      │ STOTT, JIM        │ CAPE NEDDICK │ ME       │ 039020760 │ NONE              │ NONE                    │ 05132017 │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ C00000935 │ SA11AI_81047921 │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1217152</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>        │ EARMARKED FOR DCCC (C00000935)                                  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
│ C00401224 │ A        │ M6       │ P        │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">201804059101865942</span> │ 24T      │ IND      │ STOTT, JIM        │ CAPE NEDDICK │ ME       │ 039020760 │ NONE              │ NONE                    │ 05152017 │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ C00000935 │ SA11AI_81209209 │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1217152</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>        │ EARMARKED FOR DCCC (C00000935)                                  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
│ C00401224 │ A        │ M6       │ P        │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">201804059101865942</span> │ 24T      │ IND      │ STOTT, JIM        │ CAPE NEDDICK │ ME       │ 039020760 │ NONE              │ NONE                    │ 05192017 │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> │ C00000935 │ SA11AI_81605223 │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1217152</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>        │ EARMARKED FOR DCCC (C00000935)                                  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
│ C00401224 │ A        │ M6       │ P        │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">201804059101865943</span> │ 24T      │ IND      │ STOTT, JIM        │ CAPE NEDDICK │ ME       │ 039020760 │ NONE              │ NONE                    │ 05242017 │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │ C00000935 │ SA11AI_82200022 │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1217152</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>        │ EARMARKED FOR DCCC (C00000935)                                  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
│ C00401224 │ A        │ M6       │ P        │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">201804059101865943</span> │ 24T      │ IND      │ STOTT, JIM        │ CAPE NEDDICK │ ME       │ 03902     │ NOT EMPLOYED      │ NOT EMPLOYED            │ 05292017 │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span> │ C00213512 │ SA11AI_82589834 │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1217152</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>        │ EARMARKED FOR NANCY PELOSI FOR CONGRESS (C00213512)             │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
│ C00401224 │ A        │ M6       │ P        │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">201804059101865944</span> │ 24T      │ IND      │ STOTT, JIM        │ CAPE NEDDICK │ ME       │ 039020760 │ NONE              │ NONE                    │ 05302017 │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ C00000935 │ SA11AI_82643727 │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1217152</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>        │ EARMARKED FOR DCCC (C00000935)                                  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
│ C00401224 │ A        │ M6       │ P        │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">201804059101867050</span> │ 24T      │ IND      │ STRANGE, WINIFRED │ ANNA MSRIA   │ FL       │ 34216     │ NOT EMPLOYED      │ NOT EMPLOYED            │ 05162017 │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │ C00000935 │ SA11AI_81325918 │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1217152</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>        │ EARMARKED FOR DCCC (C00000935)                                  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>        │                  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>                 │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>            │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>                 │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>                       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>        │        <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>               │        <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>                                                               │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
└───────────┴──────────┴──────────┴──────────┴────────────────────┴──────────┴──────────┴───────────────────┴──────────────┴──────────┴───────────┴───────────────────┴─────────────────────────┴──────────┴──────────┴───────────┴─────────────────┴──────────┴──────────┴─────────────────────────────────────────────────────────────────┴───┘
</pre>
</div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For a more comprehesive description of the columns and their meaning, see</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># https://www.fec.gov/campaign-finance-data/contributions-individuals-file-description/</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>columns <span class="op">=</span> {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CMTE_ID"</span>: <span class="st">"keep"</span>,  <span class="co"># Committee ID</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AMNDT_IND"</span>: <span class="st">"drop"</span>,  <span class="co"># Amendment indicator. A = amendment, N = new, T = termination</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RPT_TP"</span>: <span class="st">"drop"</span>,  <span class="co"># Report type (monthly, quarterly, etc)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TRANSACTION_PGI"</span>: <span class="st">"keep"</span>,  <span class="co"># Primary/general indicator</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"IMAGE_NUM"</span>: <span class="st">"drop"</span>,  <span class="co"># Image number</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TRANSACTION_TP"</span>: <span class="st">"drop"</span>,  <span class="co"># Transaction type</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ENTITY_TP"</span>: <span class="st">"keep"</span>,  <span class="co"># Entity type</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NAME"</span>: <span class="st">"drop"</span>,  <span class="co"># Contributor name</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CITY"</span>: <span class="st">"keep"</span>,  <span class="co"># Contributor city</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"STATE"</span>: <span class="st">"keep"</span>,  <span class="co"># Contributor state</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ZIP_CODE"</span>: <span class="st">"drop"</span>,  <span class="co"># Contributor zip code</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EMPLOYER"</span>: <span class="st">"drop"</span>,  <span class="co"># Contributor employer</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"OCCUPATION"</span>: <span class="st">"drop"</span>,  <span class="co"># Contributor occupation</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TRANSACTION_DT"</span>: <span class="st">"keep"</span>,  <span class="co"># Transaction date</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TRANSACTION_AMT"</span>: <span class="st">"keep"</span>,  <span class="co"># Transaction amount</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Other ID. For individual contributions will be null. For contributions from</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># other FEC committees, will be the committee ID of the other committee.</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"OTHER_ID"</span>: <span class="st">"drop"</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TRAN_ID"</span>: <span class="st">"drop"</span>,  <span class="co"># Transaction ID</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FILE_NUM"</span>: <span class="st">"drop"</span>,  <span class="co"># File number, unique number assigned to each report filed with the FEC</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MEMO_CD"</span>: <span class="st">"drop"</span>,  <span class="co"># Memo code</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MEMO_TEXT"</span>: <span class="st">"drop"</span>,  <span class="co"># Memo text</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SUB_ID"</span>: <span class="st">"drop"</span>,  <span class="co"># Submission ID. Unique number assigned to each transaction.</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>renaming <span class="op">=</span> {old: new <span class="cf">for</span> old, new <span class="kw">in</span> <span class="bu">zip</span>(raw.columns, columns.keys())}</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>to_keep <span class="op">=</span> [k <span class="cf">for</span> k, v <span class="kw">in</span> columns.items() <span class="cf">if</span> v <span class="op">==</span> <span class="st">"keep"</span>]</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>kept <span class="op">=</span> raw.relabel(renaming)[to_keep]</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>kept</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> CMTE_ID   </span>┃<span style="font-weight: bold"> TRANSACTION_PGI </span>┃<span style="font-weight: bold"> ENTITY_TP </span>┃<span style="font-weight: bold"> CITY         </span>┃<span style="font-weight: bold"> STATE  </span>┃<span style="font-weight: bold"> TRANSACTION_DT </span>┃<span style="font-weight: bold"> TRANSACTION_AMT </span>┃
┡━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>          │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>           │
├───────────┼─────────────────┼───────────┼──────────────┼────────┼────────────────┼─────────────────┤
│ C00401224 │ P               │ IND       │ AMSTELVEEN   │ ZZ     │ 05172017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │
│ C00401224 │ P               │ IND       │ OCOEE        │ FL     │ 05182017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │
│ C00401224 │ P               │ IND       │ OCOEE        │ FL     │ 05192017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05132017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05152017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05192017       │               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05242017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05292017       │             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05302017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │
│ C00401224 │ P               │ IND       │ ANNA MSRIA   │ FL     │ 05162017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>               │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>            │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>      │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>              │               <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
└───────────┴─────────────────┴───────────┴──────────────┴────────┴────────────────┴─────────────────┘
</pre>
</div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 21 million rows</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>kept.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div class="ansi-escaped-output">
<pre><span class="ansi-cyan-fg ansi-bold">21730731</span></pre>
</div>
</div>
</div>
<p>Huh, what’s up with those timings? Previewing the head only took a fraction of a second, but finding the number of rows took 10 seconds.</p>
<p>That’s because duckdb is scanning the .csv file on the fly every time we access it. So we only have to read the first few lines to get that preview, but we have to read the whole file to get the number of rows.</p>
<p>Note that this isn’t a feature of Ibis, but a feature of Duckdb. This what I think is one of the strengths of Ibis: Ibis itself doesn’t have to implement any of the optimimizations or features of the backends. Those backends can focus on what they do best, and Ibis can get those things for free.</p>
<p>So, let’s tell duckdb to actually read in the file to its native format so later accesses will be faster. This will be a ~20 seconds that we’ll only have to pay once.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>kept <span class="op">=</span> kept.cache()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>kept</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> CMTE_ID   </span>┃<span style="font-weight: bold"> TRANSACTION_PGI </span>┃<span style="font-weight: bold"> ENTITY_TP </span>┃<span style="font-weight: bold"> CITY         </span>┃<span style="font-weight: bold"> STATE  </span>┃<span style="font-weight: bold"> TRANSACTION_DT </span>┃<span style="font-weight: bold"> TRANSACTION_AMT </span>┃
┡━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>          │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>           │
├───────────┼─────────────────┼───────────┼──────────────┼────────┼────────────────┼─────────────────┤
│ C00401224 │ P               │ IND       │ AMSTELVEEN   │ ZZ     │ 05172017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │
│ C00401224 │ P               │ IND       │ OCOEE        │ FL     │ 05182017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │
│ C00401224 │ P               │ IND       │ OCOEE        │ FL     │ 05192017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05132017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05152017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05192017       │               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05242017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05292017       │             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span> │
│ C00401224 │ P               │ IND       │ CAPE NEDDICK │ ME     │ 05302017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │
│ C00401224 │ P               │ IND       │ ANNA MSRIA   │ FL     │ 05162017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>               │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>            │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>      │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>              │               <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
└───────────┴─────────────────┴───────────┴──────────────┴────────┴────────────────┴─────────────────┘
</pre>
</div>
</div>
<p>Look, now accessing it only takes a fraction of a second!</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>kept.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div class="ansi-escaped-output">
<pre><span class="ansi-cyan-fg ansi-bold">21730731</span></pre>
</div>
</div>
</div>
<section id="committees-data" class="level3">
<h3 class="anchored" data-anchor-id="committees-data">Committees Data</h3>
<p>The contributions only list an opaque <code>CMTE_ID</code> column. We want to know which actual committee this is. Let’s load the committees table so we can lookup from committee ID to committee name.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_committees():</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    committees_url <span class="op">=</span> <span class="st">"https://cg-519a459a-0ea3-42c2-b7bc-fa1143481f74.s3-us-gov-west-1.amazonaws.com/bulk-downloads/2018/committee_summary_2018.csv"</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This just creates a view, it doesn't actually fetch the data yet</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> ibis.read_csv(committees_url)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> tmp[<span class="st">"CMTE_ID"</span>, <span class="st">"CMTE_NM"</span>]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The raw table contains multiple rows for each committee id, so lets pick</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># an arbitrary row for each committee id as the representative name.</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    deduped <span class="op">=</span> tmp.group_by(<span class="st">"CMTE_ID"</span>).agg(CMTE_NM<span class="op">=</span>_.CMTE_NM.arbitrary())</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> deduped</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>comms <span class="op">=</span> read_committees().cache()</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>comms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> CMTE_ID   </span>┃<span style="font-weight: bold"> CMTE_NM                                  </span>┃
┡━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>                                   │
├───────────┼──────────────────────────────────────────┤
│ C00097238 │ VIAD CORP GOOD GOVERNMENT PROJECT        │
│ C00497859 │ HALL FOR CONGRESS                        │
│ C00639914 │ TOM K. PAPPAS FOR CONGRESS               │
│ C00663401 │ ENGAGING LEADERS OF THE FUTURE PAC       │
│ C00020453 │ CASS COUNTY REPUBLICAN CENTRAL COMMITTEE │
│ C00591909 │ RODNEY FRELINGHUYSEN VICTORY FUND        │
│ C00635094 │ CAPITO VICTORY COMMITTEE                 │
│ C00658310 │ ROBERT BARR FOR CONGRESS                 │
│ C00657965 │ NEW ELECTORATE                           │
│ C00485045 │ DISTRICT COUNCIL 9 POLITICAL ACTION FUND │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>                                        │
└───────────┴──────────────────────────────────────────┘
</pre>
</div>
</div>
<p>Now add a the committee name to the contributions table:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>together <span class="op">=</span> kept.left_join(comms, <span class="st">"CMTE_ID"</span>).drop(<span class="st">"CMTE_ID_x"</span>, <span class="st">"CMTE_ID_y"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>together</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━┓
┃<span style="font-weight: bold"> TRANSACTION_PGI </span>┃<span style="font-weight: bold"> ENTITY_TP </span>┃<span style="font-weight: bold"> CITY         </span>┃<span style="font-weight: bold"> STATE  </span>┃<span style="font-weight: bold"> TRANSACTION_DT </span>┃<span style="font-weight: bold"> TRANSACTION_AMT </span>┃<span style="font-weight: bold"> CMTE_NM </span>┃
┡━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>          │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>           │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>  │
├─────────────────┼───────────┼──────────────┼────────┼────────────────┼─────────────────┼─────────┤
│ P               │ IND       │ AMSTELVEEN   │ ZZ     │ 05172017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │ ACTBLUE │
│ P               │ IND       │ OCOEE        │ FL     │ 05182017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │ ACTBLUE │
│ P               │ IND       │ OCOEE        │ FL     │ 05192017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │ ACTBLUE │
│ P               │ IND       │ CAPE NEDDICK │ ME     │ 05132017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │
│ P               │ IND       │ CAPE NEDDICK │ ME     │ 05152017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │
│ P               │ IND       │ CAPE NEDDICK │ ME     │ 05192017       │               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> │ ACTBLUE │
│ P               │ IND       │ CAPE NEDDICK │ ME     │ 05242017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │ ACTBLUE │
│ P               │ IND       │ CAPE NEDDICK │ ME     │ 05292017       │             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span> │ ACTBLUE │
│ P               │ IND       │ CAPE NEDDICK │ ME     │ 05302017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │
│ P               │ IND       │ ANNA MSRIA   │ FL     │ 05162017       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │ ACTBLUE │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>               │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>            │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>      │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>              │               <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>       │
└─────────────────┴───────────┴──────────────┴────────┴────────────────┴─────────────────┴─────────┘
</pre>
</div>
</div>
</section>
</section>
<section id="cleaning" class="level2">
<h2 class="anchored" data-anchor-id="cleaning">Cleaning</h2>
<p>First, let’s drop any contributions that don’t have a committee name. There are only 6 of them.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can do this fearlessly, no .copy() needed, because</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># everything in Ibis is immutable. If we did this in pandas,</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># we might start modifying the original DataFrame accidentally!</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>cleaned <span class="op">=</span> together</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>has_name <span class="op">=</span> cleaned.CMTE_NM.notnull()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>cleaned <span class="op">=</span> cleaned[has_name]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>has_name.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> NotNull(CMTE_NM) </span>┃<span style="font-weight: bold"> NotNull(CMTE_NM)_count </span>┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">boolean</span>          │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>                  │
├──────────────────┼────────────────────────┤
│ True             │               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21730725</span> │
│ False            │                      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span> │
└──────────────────┴────────────────────────┘
</pre>
</div>
</div>
<p>Let’s look at the <code>ENTITY_TP</code> column. This represents the type of entity that made the contribution:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>together.ENTITY_TP.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> ENTITY_TP </span>┃<span style="font-weight: bold"> ENTITY_TP_count </span>┃
┡━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>    │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>           │
├───────────┼─────────────────┤
│ IND       │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21687993</span> │
│ ORG       │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18555</span> │
│ CAN       │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13659</span> │
│ PAC       │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3621</span> │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>         │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5289</span> │
│ COM       │             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">867</span> │
│ PTY       │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">49</span> │
│ CCM       │             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">698</span> │
└───────────┴─────────────────┘
</pre>
</div>
</div>
<p>We only care about contributions from individuals.</p>
<p>Once we filter on this column, the contents of it are irrelevant, so let’s drop it.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>cleaned <span class="op">=</span> together[_.ENTITY_TP <span class="op">==</span> <span class="st">"IND"</span>].drop(<span class="st">"ENTITY_TP"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It looks like the <code>TRANSACTION_DT</code> column was a raw string like “MMDDYYYY”, so let’s convert that to a proper date type.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibis.expr.types <span class="im">import</span> StringValue, DateValue</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mmddyyyy_to_date(val: StringValue) <span class="op">-&gt;</span> DateValue:</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> val.cast(<span class="bu">str</span>).lpad(<span class="dv">8</span>, <span class="st">"0"</span>).to_timestamp(<span class="st">"%m</span><span class="sc">%d</span><span class="st">%Y"</span>).date()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>cleaned <span class="op">=</span> cleaned.mutate(date<span class="op">=</span>mmddyyyy_to_date(_.TRANSACTION_DT)).drop(<span class="st">"TRANSACTION_DT"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>cleaned</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> TRANSACTION_PGI </span>┃<span style="font-weight: bold"> CITY         </span>┃<span style="font-weight: bold"> STATE  </span>┃<span style="font-weight: bold"> TRANSACTION_AMT </span>┃<span style="font-weight: bold"> CMTE_NM </span>┃<span style="font-weight: bold"> date       </span>┃
┡━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>          │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>           │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">date</span>       │
├─────────────────┼──────────────┼────────┼─────────────────┼─────────┼────────────┤
│ P               │ AMSTELVEEN   │ ZZ     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-17</span> │
│ P               │ OCOEE        │ FL     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-18</span> │
│ P               │ OCOEE        │ FL     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-19</span> │
│ P               │ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-13</span> │
│ P               │ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-15</span> │
│ P               │ CAPE NEDDICK │ ME     │               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-19</span> │
│ P               │ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-24</span> │
│ P               │ CAPE NEDDICK │ ME     │             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-29</span> │
│ P               │ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-30</span> │
│ P               │ ANNA MSRIA   │ FL     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-16</span> │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>               │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>            │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>      │               <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>          │
└─────────────────┴──────────────┴────────┴─────────────────┴─────────┴────────────┘
</pre>
</div>
</div>
<p>The <code>TRANSACTION_PGI</code> column represents the type (primary, general, etc) of election, and the year. But it seems to be not very consistent:</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cleaned.TRANSACTION_PGI.topk(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━┳━━━━━━━━━━┓
┃<span style="font-weight: bold"> TRANSACTION_PGI </span>┃<span style="font-weight: bold"> count    </span>┃
┡━━━━━━━━━━━━━━━━━╇━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>          │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>    │
├─────────────────┼──────────┤
│ P               │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17013597</span> │
│ G2018           │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2095123</span> │
│ P2018           │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1677183</span> │
│ P2020           │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">208501</span> │
│ O2018           │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">161874</span> │
│ S2017           │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">124336</span> │
│ G2017           │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">98401</span> │
│ P2022           │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">91136</span> │
│ P2017           │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">61153</span> │
│ R2017           │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">54281</span> │
└─────────────────┴──────────┘
</pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_election_type(pgi: StringValue) <span class="op">-&gt;</span> StringValue:</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Use the first letter of the TRANSACTION_PGI column to determine the election type</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">    If the first letter is not one of the known election stage, then return null.</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    election_types <span class="op">=</span> {</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"P"</span>: <span class="st">"primary"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"G"</span>: <span class="st">"general"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"O"</span>: <span class="st">"other"</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"C"</span>: <span class="st">"convention"</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"R"</span>: <span class="st">"runoff"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S"</span>: <span class="st">"special"</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E"</span>: <span class="st">"recount"</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    first_letter <span class="op">=</span> pgi[<span class="dv">0</span>]</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> first_letter.substitute(election_types, else_<span class="op">=</span>ibis.NA)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>cleaned <span class="op">=</span> cleaned.mutate(election_type<span class="op">=</span>get_election_type(_.TRANSACTION_PGI)).drop(</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TRANSACTION_PGI"</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>cleaned</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> CITY         </span>┃<span style="font-weight: bold"> STATE  </span>┃<span style="font-weight: bold"> TRANSACTION_AMT </span>┃<span style="font-weight: bold"> CMTE_NM </span>┃<span style="font-weight: bold"> date       </span>┃<span style="font-weight: bold"> election_type </span>┃
┡━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>           │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">date</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>        │
├──────────────┼────────┼─────────────────┼─────────┼────────────┼───────────────┤
│ AMSTELVEEN   │ ZZ     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-17</span> │ primary       │
│ OCOEE        │ FL     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-18</span> │ primary       │
│ OCOEE        │ FL     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-19</span> │ primary       │
│ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-13</span> │ primary       │
│ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-15</span> │ primary       │
│ CAPE NEDDICK │ ME     │               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-19</span> │ primary       │
│ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-24</span> │ primary       │
│ CAPE NEDDICK │ ME     │             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-29</span> │ primary       │
│ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-30</span> │ primary       │
│ ANNA MSRIA   │ FL     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-16</span> │ primary       │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>            │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>      │               <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>          │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>             │
└──────────────┴────────┴─────────────────┴─────────┴────────────┴───────────────┘
</pre>
</div>
</div>
<p>That worked well! There are 0 nulls in the resulting column, so we always were able to determine the election type.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>cleaned.election_type.topk(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━┳━━━━━━━━━━┓
┃<span style="font-weight: bold"> election_type </span>┃<span style="font-weight: bold"> count    </span>┃
┡━━━━━━━━━━━━━━━╇━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>    │
├───────────────┼──────────┤
│ primary       │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19061954</span> │
│ general       │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2216685</span> │
│ other         │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">161965</span> │
│ special       │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">149572</span> │
│ runoff        │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">69637</span> │
│ convention    │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22453</span> │
│ recount       │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5063</span> │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>             │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> │
└───────────────┴──────────┘
</pre>
</div>
</div>
<p>About 1/20 of transactions are negative. These could represent refunds, or they could be data entry errors. Let’s simply drop them to keep it simple.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>above_zero <span class="op">=</span> cleaned.TRANSACTION_AMT <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>cleaned <span class="op">=</span> cleaned[above_zero]</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>above_zero.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Greater(TRANSACTION_AMT, 0) </span>┃<span style="font-weight: bold"> Greater(TRANSACTION_AMT, 0)_count </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">boolean</span>                     │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>                             │
├─────────────────────────────┼───────────────────────────────────┤
│ True                        │                          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20669810</span> │
│ False                       │                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1018183</span> │
└─────────────────────────────┴───────────────────────────────────┘
</pre>
</div>
</div>
</section>
<section id="adding-features" class="level2">
<h2 class="anchored" data-anchor-id="adding-features">Adding Features</h2>
<p>Now that the data is cleaned up to a usable format, let’s add some features.</p>
<p>First, it’s useful to categorize donations by size, placing them into buckets of small, medium, large, etc.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>edges <span class="op">=</span> [</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">50</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">500</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1000</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5000</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"&lt;10"</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"10-50"</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"50-100"</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"100-500"</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"500-1000"</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1000-5000"</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5000+"</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bucketize(vals, edges, str_labels):</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Uses Ibis's .bucket() method to create a categorical column</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    int_labels <span class="op">=</span> vals.bucket(edges, include_under<span class="op">=</span><span class="va">True</span>, include_over<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map the integer labels to the string labels</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    int_to_str <span class="op">=</span> {<span class="bu">str</span>(i): s <span class="cf">for</span> i, s <span class="kw">in</span> <span class="bu">enumerate</span>(str_labels)}</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> int_labels.cast(<span class="bu">str</span>).substitute(int_to_str)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>featured <span class="op">=</span> cleaned.mutate(amount_bucket<span class="op">=</span>bucketize(_.TRANSACTION_AMT, edges, labels))</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>featured</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> CITY         </span>┃<span style="font-weight: bold"> STATE  </span>┃<span style="font-weight: bold"> TRANSACTION_AMT </span>┃<span style="font-weight: bold"> CMTE_NM </span>┃<span style="font-weight: bold"> date       </span>┃<span style="font-weight: bold"> election_type </span>┃<span style="font-weight: bold"> amount_bucket </span>┃
┡━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>           │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>  │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">date</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>        │
├──────────────┼────────┼─────────────────┼─────────┼────────────┼───────────────┼───────────────┤
│ AMSTELVEEN   │ ZZ     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-17</span> │ primary       │ 10-50         │
│ OCOEE        │ FL     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-18</span> │ primary       │ 10-50         │
│ OCOEE        │ FL     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-19</span> │ primary       │ 10-50         │
│ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-13</span> │ primary       │ 10-50         │
│ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-15</span> │ primary       │ 10-50         │
│ CAPE NEDDICK │ ME     │               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-19</span> │ primary       │ &lt;10           │
│ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-24</span> │ primary       │ 10-50         │
│ CAPE NEDDICK │ ME     │             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-29</span> │ primary       │ 100-500       │
│ CAPE NEDDICK │ ME     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-30</span> │ primary       │ 10-50         │
│ ANNA MSRIA   │ FL     │              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │ ACTBLUE │ <span style="color: #800080; text-decoration-color: #800080">2017-05-16</span> │ primary       │ 10-50         │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>            │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>      │               <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>          │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>             │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>             │
└──────────────┴────────┴─────────────────┴─────────┴────────────┴───────────────┴───────────────┘
</pre>
</div>
</div>
</section>
<section id="analysis" class="level2">
<h2 class="anchored" data-anchor-id="analysis">Analysis</h2>
<section id="by-donation-size" class="level3">
<h3 class="anchored" data-anchor-id="by-donation-size">By donation size</h3>
<p>One thing we can look at is the donation breakdown by size: - Are most donations small or large? - Where do politicians/committees get most of their money from? Large or small donations?</p>
<p>We also will compare performance of Ibis vs pandas during this groupby.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summary_by(table, by):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table.group_by(by).agg(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>        n_donations<span class="op">=</span>_.count(),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        total_amount<span class="op">=</span>_.TRANSACTION_AMT.<span class="bu">sum</span>(),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        mean_amount<span class="op">=</span>_.TRANSACTION_AMT.mean(),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        median_amount<span class="op">=</span>_.TRANSACTION_AMT.approx_median(),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summary_by_pandas(df, by):</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.groupby(by, as_index<span class="op">=</span><span class="va">False</span>).agg(</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        n_donations<span class="op">=</span>(<span class="st">"election_type"</span>, <span class="st">"count"</span>),</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        total_amount<span class="op">=</span>(<span class="st">"TRANSACTION_AMT"</span>, <span class="st">"sum"</span>),</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        mean_amount<span class="op">=</span>(<span class="st">"TRANSACTION_AMT"</span>, <span class="st">"mean"</span>),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        median_amount<span class="op">=</span>(<span class="st">"TRANSACTION_AMT"</span>, <span class="st">"median"</span>),</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co"># persist the input data so the following timings of the group_by are accurate.</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>subset <span class="op">=</span> featured[<span class="st">"election_type"</span>, <span class="st">"amount_bucket"</span>, <span class="st">"TRANSACTION_AMT"</span>]</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>subset <span class="op">=</span> subset.cache()</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>pandas_subset <span class="op">=</span> subset.execute()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s take a look at what we are actually computing:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>by_type_and_bucket <span class="op">=</span> summary_by(subset, [<span class="st">"election_type"</span>, <span class="st">"amount_bucket"</span>])</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>by_type_and_bucket</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> election_type </span>┃<span style="font-weight: bold"> amount_bucket </span>┃<span style="font-weight: bold"> n_donations </span>┃<span style="font-weight: bold"> total_amount </span>┃<span style="font-weight: bold"> mean_amount  </span>┃<span style="font-weight: bold"> median_amount </span>┃
┡━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">float64</span>      │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>         │
├───────────────┼───────────────┼─────────────┼──────────────┼──────────────┼───────────────┤
│ primary       │ 10-50         │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8115404</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">187666261</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23.124697</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │
│ primary       │ 50-100        │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2663933</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">155426540</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">58.344763</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">50</span> │
│ primary       │ 100-500       │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3636287</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">637353634</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">175.275943</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">150</span> │
│ primary       │ &lt;10           │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2423728</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10080721</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4.159180</span> │             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> │
│ primary       │ 500-1000      │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">634677</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">334630687</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">527.245649</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">500</span> │
│ primary       │ 1000-5000     │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">684755</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1231394874</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1798.299938</span> │          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1005</span> │
│ general       │ 1000-5000     │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">246101</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">460025242</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1869.253851</span> │          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1965</span> │
│ general       │ 100-500       │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">700821</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">123174568</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">175.757530</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">150</span> │
│ general       │ 500-1000      │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">174182</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">91015697</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">522.532162</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">500</span> │
│ primary       │ 5000+         │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">44085</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1558371116</span> │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35349.237065</span> │         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10000</span> │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>             │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>             │           <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │            <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │            <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │             <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
└───────────────┴───────────────┴─────────────┴──────────────┴──────────────┴───────────────┘
</pre>
</div>
</div>
<p>OK, now let’s do our timings.</p>
<p>One interesting thing to pay attention to here is the execution time for the following groupby. Before, we could get away with lazy execution: because we only wanted to preview the first few rows, we only had to compute the first few rows, so all our previews were very fast.</p>
<p>But now, as soon as we do a groupby, we have to actually go through the whole dataset in order to compute the aggregate per group. So this is going to be slower. BUT, duckdb is still quite fast. It only takes .4 seconds to groupby-agg all 20 million rows!</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit summary_by(subset, [<span class="st">"election_type"</span>, <span class="st">"amount_bucket"</span>]).execute()  <span class="co"># .execute() so we actually fetch the data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>532 ms ± 22.7 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<p>Now let’s try the same thing in pandas:</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit summary_by_pandas(pandas_subset, [<span class="st">"election_type"</span>, <span class="st">"amount_bucket"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5.03 s ± 222 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<p>It takes about 4 seconds, which is about 10 times slower than duckdb. At this scale, it again doesn’t matter, but you could imagine with a dataset much larger than this, it would matter.</p>
<p>Let’s also think about memory usage:</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pandas_subset.memory_usage(deep<span class="op">=</span><span class="va">True</span>).<span class="bu">sum</span>() <span class="op">/</span> <span class="fl">1e9</span>  <span class="co"># GB</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>2.782586797</code></pre>
</div>
</div>
<p>The source dataframe is couple gigabytes, so probably during the groupby, the peak memory usage is going to be a bit higher than this. You could use a profiler such as <a href="https://github.com/pythonspeed/filprofiler">FIL</a> if you wanted an exact number, I was too lazy to use that here.</p>
<p>Again, this works on my laptop at this dataset size, but much larger than this and I’d start having problems. Duckdb on the other hand is designed around working out of core so it should scale to datasets into the hundreds of gigabytes, much larger than your computer’s RAM.</p>
</section>
<section id="back-to-analysis" class="level3">
<h3 class="anchored" data-anchor-id="back-to-analysis">Back to analysis</h3>
<p>OK, let’s plot the result of that groupby.</p>
<p>Surprise! (Or maybe not…) Most donations are small. But most of the money comes from donations larger than $1000.</p>
<p>Well if that’s the case, why do politicians spend so much time soliciting small donations? One explanation is that they can use the number of donations as a marketing pitch, to show how popular they are, and thus how viable of a candidate they are.</p>
<p>This also might explain whose interests are being served by our politicians.</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Save as .svg so we can embed in the docs, normally not needed if in a notebook.</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This import is needed to add chromedriver to PATH so that altair_saver can find it.</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> chromedriver_binary</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>alt.renderers.enable(<span class="st">"png"</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>alt.renderers.set_embed_options(width<span class="op">=</span><span class="dv">500</span>, height<span class="op">=</span><span class="dv">600</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Do some bookkeeping so the buckets are displayed smallest to largest on the charts</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>bucket_col <span class="op">=</span> alt.Column(<span class="st">"amount_bucket:N"</span>, sort<span class="op">=</span>labels)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>n_by_bucket <span class="op">=</span> (</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    alt.Chart(by_type_and_bucket.execute())</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    .mark_bar()</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    .encode(</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>bucket_col,</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"n_donations:Q"</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"election_type:N"</span>,</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>total_by_bucket <span class="op">=</span> (</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    alt.Chart(by_type_and_bucket.execute())</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    .mark_bar()</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    .encode(</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>bucket_col,</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"total_amount:Q"</span>,</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"election_type:N"</span>,</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>n_by_bucket <span class="op">|</span> total_by_bucket</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<p><img src="campaign-finance_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="by-election-stage" class="level3">
<h3 class="anchored" data-anchor-id="by-election-stage">By election stage</h3>
<p>Let’s look at how donations break down by election stage. Do people donate differently for primary elections vs general elections?</p>
<p>Let’s ignore everything but primary and general elections, since they are the most common, and arguably the most important.</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>gb2 <span class="op">=</span> by_type_and_bucket[_.election_type.isin((<span class="st">"primary"</span>, <span class="st">"general"</span>))]</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>n_donations_per_election_type <span class="op">=</span> _.n_donations.<span class="bu">sum</span>().over(group_by<span class="op">=</span><span class="st">"election_type"</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>frac <span class="op">=</span> _.n_donations <span class="op">/</span> n_donations_per_election_type</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>gb2 <span class="op">=</span> gb2.mutate(frac_n_donations_per_election_type<span class="op">=</span>frac)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>gb2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> election_type </span>┃<span style="font-weight: bold"> amount_bucket </span>┃<span style="font-weight: bold"> n_donations </span>┃<span style="font-weight: bold"> total_amount </span>┃<span style="font-weight: bold"> mean_amount  </span>┃<span style="font-weight: bold"> median_amount </span>┃<span style="font-weight: bold"> frac_n_donations_per_election_type </span>┃
┡━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">float64</span>      │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">float64</span>                            │
├───────────────┼───────────────┼─────────────┼──────────────┼──────────────┼───────────────┼────────────────────────────────────┤
│ primary       │ &lt;10           │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2423728</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10080721</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4.159180</span> │             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> │                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.133151</span> │
│ primary       │ 1000-5000     │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">684755</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1231394874</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1798.299938</span> │          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1007</span> │                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.037618</span> │
│ primary       │ 10-50         │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8115404</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">187666261</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23.124697</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.445831</span> │
│ primary       │ 50-100        │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2663933</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">155426540</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">58.344763</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">50</span> │                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.146347</span> │
│ primary       │ 100-500       │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3636287</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">637353634</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">175.275943</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">150</span> │                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.199764</span> │
│ primary       │ 500-1000      │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">634677</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">334630687</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">527.245649</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">500</span> │                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.034867</span> │
│ primary       │ 5000+         │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">44085</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1558371116</span> │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35349.237065</span> │         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10000</span> │                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.002422</span> │
│ general       │ 100-500       │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">700821</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">123174568</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">175.757530</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">150</span> │                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.317796</span> │
│ general       │ &lt;10           │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">115873</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">536742</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4.632158</span> │             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> │                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.052544</span> │
│ general       │ 10-50         │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">660787</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14411588</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21.809733</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.299642</span> │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>             │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>             │           <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │            <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │            <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │             <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │                                  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
└───────────────┴───────────────┴─────────────┴──────────────┴──────────────┴───────────────┴────────────────────────────────────┘
</pre>
</div>
</div>
<p>It looks like primary elections get a larger proportion of small donations.</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>alt.Chart(gb2.execute()).mark_bar().encode(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"election_type:O"</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"frac_n_donations_per_election_type:Q"</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>bucket_col,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<p><img src="campaign-finance_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="by-recipient" class="level3">
<h3 class="anchored" data-anchor-id="by-recipient">By recipient</h3>
<p>Let’s look at the top players. Who gets the most donations?</p>
<p>Far and away it is ActBlue, which acts as a conduit for donations to Democratic interests.</p>
<p>Beto O’Rourke is the top individual politician, hats off to him!</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>by_recip <span class="op">=</span> summary_by(featured, <span class="st">"CMTE_NM"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>by_recip</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> CMTE_NM                                                            </span>┃<span style="font-weight: bold"> n_donations </span>┃<span style="font-weight: bold"> total_amount </span>┃<span style="font-weight: bold"> mean_amount </span>┃<span style="font-weight: bold"> median_amount </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>                                                             │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">float64</span>     │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>         │
├────────────────────────────────────────────────────────────────────┼─────────────┼──────────────┼─────────────┼───────────────┤
│ BRIDGESTONE AMERICAS INC. PAC                                      │         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">384</span> │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">42632</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">111.020833</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">50</span> │
│ CORELOGIC INC PAC                                                  │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span> │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11000</span> │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2750.000000</span> │          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2750</span> │
│ CROWLEY MARITIME CORPORATION FEDERAL PAC                           │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1137</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">192839</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">169.603342</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span> │
│ NATIONAL PROPANE GAS ASSOCIATION POLITICAL ACTION COMMITTEE        │         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">475</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">198445</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">417.778947</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">152</span> │
│ BWX TECHNOLOGIES, INC POLITICAL ACTION COMMITTEE                   │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4839</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">431450</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">89.160984</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">64</span> │
│ CHEVRON EMPLOYEES POLITICAL ACTION COMMITTEE - CHEVRON CORPORATION │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12356</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">883848</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">71.531887</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34</span> │
│ EMILY'S LIST                                                       │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">174381</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">29222927</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">167.580912</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">50</span> │
│ OKLAHOMA STRONG LEADERSHIP PAC                                     │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> │         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5500</span> │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2750.000000</span> │          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2750</span> │
│ AMERICANS UNITED IN SUPPORT OF DEMOCRACY                           │          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">64</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">256300</span> │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4004.687500</span> │          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5000</span> │
│ AMERICAN SENIORS HOUSING ASSOCIATION (SENIORS HOUSING PAC)         │         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">341</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">805502</span> │ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2362.175953</span> │          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2000</span> │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>                                                                  │           <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │            <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │           <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │             <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
└────────────────────────────────────────────────────────────────────┴─────────────┴──────────────┴─────────────┴───────────────┘
</pre>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>top_recip <span class="op">=</span> by_recip.order_by(ibis.desc(<span class="st">"n_donations"</span>)).head(<span class="dv">10</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>alt.Chart(top_recip.execute()).mark_bar().encode(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">"CMTE_NM:O"</span>, sort<span class="op">=</span><span class="st">"-y"</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"n_donations:Q"</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<p><img src="campaign-finance_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="by-location" class="level3">
<h3 class="anchored" data-anchor-id="by-location">By Location</h3>
<p>Where are the largest donations coming from?</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>f2 <span class="op">=</span> featured.mutate(loc<span class="op">=</span>_.CITY <span class="op">+</span> <span class="st">", "</span> <span class="op">+</span> _.STATE).drop(<span class="st">"CITY"</span>, <span class="st">"STATE"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>by_loc <span class="op">=</span> summary_by(f2, <span class="st">"loc"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop the places with a small number of donations so we're</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># resistant to outliers for the mean</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>by_loc <span class="op">=</span> by_loc[_.n_donations <span class="op">&gt;</span> <span class="dv">1000</span>]</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>by_loc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> loc                 </span>┃<span style="font-weight: bold"> n_donations </span>┃<span style="font-weight: bold"> total_amount </span>┃<span style="font-weight: bold"> mean_amount </span>┃<span style="font-weight: bold"> median_amount </span>┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>              │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">float64</span>     │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>         │
├─────────────────────┼─────────────┼──────────────┼─────────────┼───────────────┤
│ NORTHVILLE, MI      │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7926</span> │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1377925</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">173.848726</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">50</span> │
│ MISSOULA, MT        │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19647</span> │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3628034</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">184.660966</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">27</span> │
│ MIDDLETOWN, DE      │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1565</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">515802</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">329.585942</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │
│ RALEIGH, NC         │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36381</span> │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6424836</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">176.598664</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │
│ LOUISVILLE, KY      │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40812</span> │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8840210</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">216.608105</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37</span> │
│ JACKSON HEIGHTS, NY │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2555</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">266927</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">104.472407</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34</span> │
│ BROKEN ARROW, OK    │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3844</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">409471</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">106.522112</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │
│ ARLINGTON, MA       │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12807</span> │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1967560</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">153.631608</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">38</span> │
│ CORALVILLE, IA      │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3318</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">284634</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">85.784810</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │
│ CORNISH, NH         │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3026</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">140696</span> │   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">46.495704</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span> │
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>                   │           <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │            <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │           <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │             <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │
└─────────────────────┴─────────────┴──────────────┴─────────────┴───────────────┘
</pre>
</div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> top_by(col):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    top <span class="op">=</span> by_loc.order_by(ibis.desc(col)).head(<span class="dv">10</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        alt.Chart(top.execute())</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        .mark_bar()</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        .encode(</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span>alt.X(<span class="st">'loc:O'</span>, sort<span class="op">=</span><span class="st">"-y"</span>),</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span>col,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>top_by(<span class="st">"n_donations"</span>) <span class="op">|</span> top_by(<span class="st">"total_amount"</span>) <span class="op">|</span> top_by(<span class="st">"mean_amount"</span>) <span class="op">|</span> top_by(</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"median_amount"</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<p><img src="campaign-finance_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="by-month" class="level3">
<h3 class="anchored" data-anchor-id="by-month">By month</h3>
<p>When do the donations come in?</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>by_month <span class="op">=</span> summary_by(featured, _.date.month().name(<span class="st">"month_int"</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Sorta hacky, .substritute doesn't work to change dtypes (yet?)</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># so we cast to string and then do our mapping</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>month_map <span class="op">=</span> {</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1"</span>: <span class="st">"Jan"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2"</span>: <span class="st">"Feb"</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"3"</span>: <span class="st">"Mar"</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4"</span>: <span class="st">"Apr"</span>,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5"</span>: <span class="st">"May"</span>,</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"6"</span>: <span class="st">"Jun"</span>,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"7"</span>: <span class="st">"Jul"</span>,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"8"</span>: <span class="st">"Aug"</span>,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"9"</span>: <span class="st">"Sep"</span>,</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"10"</span>: <span class="st">"Oct"</span>,</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"11"</span>: <span class="st">"Nov"</span>,</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"12"</span>: <span class="st">"Dec"</span>,</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>by_month <span class="op">=</span> by_month.mutate(month_str<span class="op">=</span>_.month_int.cast(<span class="bu">str</span>).substitute(month_map))</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>by_month</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━┓
┃<span style="font-weight: bold"> month_int </span>┃<span style="font-weight: bold"> n_donations </span>┃<span style="font-weight: bold"> total_amount </span>┃<span style="font-weight: bold"> mean_amount </span>┃<span style="font-weight: bold"> median_amount </span>┃<span style="font-weight: bold"> month_str </span>┃
┡━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━┩
│ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int32</span>     │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>        │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">float64</span>     │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">int64</span>         │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">string</span>    │
├───────────┼─────────────┼──────────────┼─────────────┼───────────────┼───────────┤
│         <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span> │        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1514</span> │       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">250297</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">165.321664</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">∅</span>         │
│         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span> │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">348979</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">174837854</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">500.998209</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">121</span> │ Jan       │
│         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> │      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">581646</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">255997655</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">440.126219</span> │           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span> │ Feb       │
│         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1042577</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">430906797</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">413.309326</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">81</span> │ Mar       │
│         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1088244</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">299252692</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">274.986760</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">50</span> │ Apr       │
│         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1374248</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">387317202</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">281.839378</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">48</span> │ May       │
│         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1667285</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">465305247</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">279.079610</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">44</span> │ Jun       │
│         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1607053</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">320528605</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">199.451172</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ Jul       │
│         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2023466</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">473544182</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">234.026261</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span> │ Aug       │
│         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span> │     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2583847</span> │    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">697888624</span> │  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">270.096729</span> │            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">38</span> │ Sep       │
│         <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │           <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │            <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │           <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │             <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span> │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">…</span>         │
└───────────┴─────────────┴──────────────┴─────────────┴───────────────┴───────────┘
</pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>months_in_order <span class="op">=</span> <span class="bu">list</span>(month_map.values())</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>alt.Chart(by_month.execute()).mark_bar().encode(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">"month_str:O"</span>, sort<span class="op">=</span>months_in_order),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"n_donations:Q"</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<p><img src="campaign-finance_files/figure-html/cell-32-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Thanks for following along! I hope you’ve learned something about Ibis, and maybe even about campaign finance.</p>
<p>Ibis is a great tool for exploring data. I now find myself reaching for it when in the past I would have reached for pandas.</p>
<p>Some of the highlights for me:</p>
<ul>
<li>Fast, lazy execution, a great display format, and good type hinting/editor support for a great REPL experience.</li>
<li>Very well thought-out API and semantics (e.g.&nbsp;<code>isinstance(val, NumericValue)</code>?? That’s beautiful!)</li>
<li>Fast and fairly complete string support, since I work with a lot of text data.</li>
<li>Extremely responsive maintainers. Sometimes I’ve submitted multiple feature requests and bug reports in a single day, and a PR has been merged by the next day.</li>
<li>Escape hatch to SQL. I didn’t have to use that here, but if something isn’t supported, you can always fall back to SQL.</li>
</ul>
<p>Check out <a href="https://ibis-project.org/">The Ibis Website</a> for more information.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>