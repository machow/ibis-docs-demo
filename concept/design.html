<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>. – design</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">.</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../concept/why_ibis.html" rel="" target="" aria-current="page">
 <span class="menu-text">Why Ibis?</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../tutorial/index.html" rel="" target="">
 <span class="menu-text">Ibis tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../how_to/configuration.html" rel="" target="">
 <span class="menu-text">Configure Ibis</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../reference/index.html" rel="" target="">
 <span class="menu-text">Reference</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog/rendered/ibis-version-6.0.0-release.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../release_notes.html" rel="" target="">
 <span class="menu-text">🚧 Release notes</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../concept/design.html">Design</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concept/why_ibis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Why Ibis?</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concept/design.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Design</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concept/backends.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Backends</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#design" id="toc-design" class="nav-link active" data-scroll-target="#design">Design</a>
  <ul class="collapse">
  <li><a href="#primary-goals" id="toc-primary-goals" class="nav-link" data-scroll-target="#primary-goals">Primary Goals</a></li>
  <li><a href="#flow-of-execution" id="toc-flow-of-execution" class="nav-link" data-scroll-target="#flow-of-execution">Flow of Execution</a></li>
  <li><a href="#expressions" id="toc-expressions" class="nav-link" data-scroll-target="#expressions">Expressions</a>
  <ul class="collapse">
  <li><a href="#type-system" id="toc-type-system" class="nav-link" data-scroll-target="#type-system">Type System</a></li>
  <li><a href="#the-expribis.expr.types.expr-class" id="toc-the-expribis.expr.types.expr-class" class="nav-link" data-scroll-target="#the-expribis.expr.types.expr-class">The [<code>Expr</code>][ibis.expr.types.Expr] class</a></li>
  <li><a href="#the-ibis.expr.types.node-class" id="toc-the-ibis.expr.types.node-class" class="nav-link" data-scroll-target="#the-ibis.expr.types.node-class">The <code>ibis.expr.types.Node</code> Class</a></li>
  <li><a href="#expressions-vs-operations-why-are-they-different" id="toc-expressions-vs-operations-why-are-they-different" class="nav-link" data-scroll-target="#expressions-vs-operations-why-are-they-different">Expressions vs Operations: Why are they different?</a></li>
  </ul></li>
  <li><a href="#compilation" id="toc-compilation" class="nav-link" data-scroll-target="#compilation">Compilation</a></li>
  <li><a href="#execution" id="toc-execution" class="nav-link" data-scroll-target="#execution">Execution</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="design" class="level1">
<h1>Design</h1>
<section id="primary-goals" class="level2">
<h2 class="anchored" data-anchor-id="primary-goals">Primary Goals</h2>
<ol type="1">
<li>Type safety</li>
<li>Expressiveness</li>
<li>Composability</li>
<li>Familiarity</li>
</ol>
</section>
<section id="flow-of-execution" class="level2">
<h2 class="anchored" data-anchor-id="flow-of-execution">Flow of Execution</h2>
<ol type="1">
<li>User writes expression</li>
<li>Each method or function call builds a new expression</li>
<li>Expressions are type checked as you create them</li>
<li>Expressions have some optimizations that happen as the user builds them</li>
<li>Backend specific rewrites</li>
<li>Expressions are compiled</li>
<li>The SQL string that generated by the compiler is sent to the database and executed (this step is skipped for the pandas backend)</li>
<li>The database returns some data that is then turned into a pandas DataFrame by Ibis</li>
</ol>
</section>
<section id="expressions" class="level2">
<h2 class="anchored" data-anchor-id="expressions">Expressions</h2>
<p>The main user-facing component of Ibis is expressions. The base class of all expressions in Ibis is the [ibis.expr.types.Expr][] class.</p>
<p>Expressions provide the user facing API, most of which is defined in <code>ibis/expr/api.py</code>.</p>
<section id="type-system" class="level3">
<h3 class="anchored" data-anchor-id="type-system">Type System</h3>
<p>Ibis’s type system consists of a set of rules for specifying the types of inputs to <code>ibis.expr.types.Node</code> subclasses. Upon construction of a <code>Node</code> subclass, Ibis performs validation of every input to the node based on the rule that was used to declare the input.</p>
<p>Rules are defined in <code>ibis.expr.rules</code></p>
<!-- prettier-ignore-start -->
</section>
<section id="the-expribis.expr.types.expr-class" class="level3">
<h3 class="anchored" data-anchor-id="the-expribis.expr.types.expr-class">The [<code>Expr</code>][ibis.expr.types.Expr] class</h3>
<!-- prettier-ignore-end -->
<p>Expressions are a thin but important abstraction over operations, containing only type information and shape information, i.e., whether they are tables, columns, or scalars.</p>
<!-- prettier-ignore-start -->
<p>Examples of expression types include [<code>StringValue</code>][ibis.expr.types.StringValue] and [<code>Table</code>][ibis.expr.types.Table]. <!-- prettier-ignore-end --></p>
<!-- prettier-ignore-start -->
</section>
<section id="the-ibis.expr.types.node-class" class="level3">
<h3 class="anchored" data-anchor-id="the-ibis.expr.types.node-class">The <code>ibis.expr.types.Node</code> Class</h3>
<!-- prettier-ignore-end -->
<p><code>Node</code> subclasses make up the core set of operations of Ibis. Each node corresponds to a particular operation.</p>
<p>Most nodes are defined in the <code>ibis.expr.operations</code> module.</p>
<p>Examples of nodes include <code>ibis.expr.operations.Add</code> and <code>ibis.expr.operations.Sum</code>.</p>
<p>Nodes (transitively) inherit from a class that allows node authors to define their node’s input arguments directly in the class body.</p>
<p>Additionally the <code>output_type</code> member of the class is a rule or method that defines the shape (scalar or column) and element type of the operation.</p>
<p>An example of usage is a node that representats a logarithm operation:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ibis.expr.rules <span class="im">as</span> rlz</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibis.expr.operations <span class="im">import</span> Value</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Log(Value):</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>   <span class="co"># A double scalar or column</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>   arg <span class="op">=</span> rlz.double</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Optional argument, defaults to None</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>   base <span class="op">=</span> rlz.optional(rlz.double)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Output expression's datatype will correspond to arg's datatype</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>   output_dtype <span class="op">=</span> rlz.dtype_like(<span class="st">'arg'</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Output expression will be scalar if arg is scalar, column otherwise</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>   output_shape <span class="op">=</span> rlz.shape_like(<span class="st">'arg'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This class describes an operation called <code>Log</code> that takes one required argument: a double scalar or column, and one optional argument: a double scalar or column named <code>base</code> that defaults to nothing if not provided. The <code>base</code> argument is <code>None</code> by default so that the expression will behave as the underlying database does.</p>
<p>Similar objects are instantiated when you use Ibis APIs:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ibis</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> ibis.table([(<span class="st">'a'</span>, <span class="st">'float'</span>)], name<span class="op">=</span><span class="st">'t'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>log_1p <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> t.a).log()  <span class="co"># an Add and a Log are instantiated here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="expressions-vs-operations-why-are-they-different" class="level3">
<h3 class="anchored" data-anchor-id="expressions-vs-operations-why-are-they-different">Expressions vs Operations: Why are they different?</h3>
<p>Separating expressions from their underlying operations makes it easy to generically describe and validate the inputs to particular nodes. In the log example, it doesn’t matter what <em>operation</em> (node) the double-valued arguments are coming from, they must only satisfy the requirement denoted by the rule.</p>
<p>Separation of the <code>ibis.expr.types.Node</code> and <code>ibis.expr.types.Expr</code> classes also allows the API to be tied to the physical type of the expression rather than the particular operation, making it easy to define the API in terms of types rather than specific operations.</p>
<p>Furthermore, operations often have an output type that depends on the input type. An example of this is the <code>greatest</code> function, which takes the maximum of all of its arguments. Another example is <code>CASE</code> statements, whose <code>THEN</code> expressions determine the output type of the expression.</p>
<p>This allows Ibis to provide <strong>only</strong> the APIs that make sense for a particular type, even when an operation yields a different output type depending on its input. Concretely, this means that you cannot perform operations that don’t make sense, like computing the average of a string column.</p>
</section>
</section>
<section id="compilation" class="level2">
<h2 class="anchored" data-anchor-id="compilation">Compilation</h2>
<p>The next major component of Ibis is the compilers.</p>
<p>The first few versions of Ibis directly generated strings, but the compiler infrastructure was generalized to support compilation of <a href="https://docs.sqlalchemy.org/en/latest/core/tutorial.html">SQLAlchemy</a> based expressions.</p>
<p>The compiler works by translating the different pieces of SQL expression into a string or SQLAlchemy expression.</p>
<p>The main pieces of a <code>SELECT</code> statement are:</p>
<p>!. The set of column expressions (<code>select_set</code>) !. <code>WHERE</code> clauses (<code>where</code>) !. <code>GROUP BY</code> clauses (<code>group_by</code>) !. <code>HAVING</code> clauses (<code>having</code>) !. <code>LIMIT</code> clauses (<code>limit</code>) !. <code>ORDER BY</code> clauses (<code>order_by</code>) !. <code>DISTINCT</code> clauses (<code>distinct</code>)</p>
<p>Each of these pieces is translated into a SQL string and finally assembled by the instance of the <code>ibis.sql.compiler.ExprTranslator</code> subclass specific to the backend being compiled. For example, the <code>ibis.impala.compiler.ImpalaExprTranslator</code> is one of the subclasses that will perform this translation.</p>
<p>!!! note “Ibis can target other systems besides SQL”</p>
<pre><code>While Ibis was designed with an explicit goal of first-class SQL support,
Ibis can target other systems such as pandas.</code></pre>
</section>
<section id="execution" class="level2">
<h2 class="anchored" data-anchor-id="execution">Execution</h2>
<p>Presumably we want to <em>do</em> something with our compiled expressions. This is where execution comes in.</p>
<p>This is least complex part of Ibis, mostly only requiring Ibis to correctly handle whatever the database hands back.</p>
<p>By and large, the execution of compiled SQL is handled by the database to which SQL is sent from Ibis.</p>
<p>However, once the data arrives from the database we need to convert that data to a pandas DataFrame.</p>
<p>The Query class, with its <code>ibis.sql.client.Query._fetch</code> method, provides a way for Ibis <code>ibis.sql.client.SQLClient</code> objects to do any additional processing necessary after the database returns results to the client.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>